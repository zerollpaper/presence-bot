# 📋 Presence Bot

Slackチーム向けの在室・予定管理ボット。メンバーの在室状況や予定を簡単に共有・可視化できます。

## ✨ 機能

- **リアルタイムボード表示**: ピン留めされたボードが自動更新
- **日付変更時の自動更新**: 1時間ごとに日付をチェックし、0時を過ぎると自動更新
- **柔軟な日付指定**: 曜日・日付・月名での予定登録
- **複数ステータス対応**: in/out/pm/home/maybe/trip/will/can
- **週間ビュー**: 最大10週間分の予定を一覧表示
- **個人スケジュール確認**: ユーザー単位での予定確認
- **自動クリーンアップ**: 過去の日付は自動削除

## 🚀 セットアップ

### 必要要件

- Python 3.9以上
- Slack App（Bot Token, App Token）
- Socket Mode対応

### 依存パッケージ

```bash
pip install slack-bolt python-dotenv certifi
pip install backports.zoneinfo  # Python 3.8以下の場合
```

### 環境変数

`.env`ファイルを作成し、以下の変数を設定：

```env
SLACK_BOT_TOKEN=xoxb-your-bot-token
SLACK_APP_TOKEN=xapp-your-app-token
ADMIN_USERS=U123456789,U987654321  # カンマ区切り（オプション）
DEBUG=1  # デバッグモード（オプション、本番では0に）
```

### Slack Appの設定

1. **OAuth & Permissions**で必要なスコープを追加：
   - `chat:write`
   - `users:read`
   - `pins:write`
   - `channels:history`
   - `chat:write.public`
   - `commands`

2. **Socket Mode**を有効化

3. **Slash Commands**を登録：
   - `/setup`
   - `/in`, `/out`, `/pm`, `/home`
   - `/maybe`, `/trip`, `/will`, `/can`
   - `/clear`, `/note`, `/lab`, `/update`
   - `/delete`（管理者用）

### 起動

```bash
python app.py
```

## 📖 使い方

### 初期設定

```bash
/setup
```

チャンネルに在室ボードを作成し、ピン留めします。

### ステータス登録

**基本コマンド（曜日指定可能）**

```bash
/in              # 今日を「出勤」に
/in mon tue      # 月曜と火曜を「出勤」に
/out mon-fri     # 月〜金を「外出」に
/pm wed 午後のみ # メモ付き
/home thu        # 木曜を「在宅」に
```

**日付指定可能なコマンド**

```bash
/trip 2/1-2/5           # 2月1日〜5日
/maybe 2/10 2/15        # 2月10日と15日
/will 2/1,2/2,2/5       # カンマ区切り
/can jan feb            # 1月と2月の全日
```

### 表示・削除

```bash
/lab              # 今日の状況
/lab week         # 今週（7日間）
/lab 3            # 3週間分
/lab @user        # 特定ユーザーの全予定

/update           # ボードを手動更新

/clear            # 今日を削除
/clear week       # 今週を削除
/clear 2          # 2週間分を削除
/clear all        # 全削除
```

### メモの追加

```bash
/note ミーティング多め  # 今日のメモを更新
```

## 📅 日付・曜日の指定ルール

### 曜日指定

- `mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`
- フルスペル可（`monday`, `tuesday`など）
- 範囲指定：`mon-fri`（ハイフンの前後にスペース不可）
- 複数指定：`mon tue wed`（スペース区切り）

### 日付指定

**✅ 有効な形式**
- `2/1 2/2 2/5` - スペース区切り
- `2/1,2/2,2/5` - カンマ区切り
- `2/1-2/5` - 範囲指定（両方とも月/日形式必須）
- `1/20-2/5` - 月をまたぐ範囲

**❌ 無効な形式**
- `2/1-5` - 月省略不可（`2/1-2/5`と書く）
- `2/1 3 4` - 月省略不可
- `mon - fri` - ハイフンの前後にスペースがある

### 月指定

- `jan`, `feb`, `mar`...（3文字略語）
- `january`, `february`...（フルスペル）
- その月の全日が対象
- 過去の月は自動的に来年として扱われる

## 🎯 ステータス一覧

| コマンド | 絵文字 | 意味 | 日付指定 |
|---------|--------|------|---------|
| `/in` | ✅ | 出勤・在室 | 曜日のみ |
| `/out` | ❌ | 外出・不在 | 曜日のみ |
| `/pm` | 🕒 | 午後のみ在室 | 曜日のみ |
| `/home` | 🏠 | リモート・在宅 | 曜日のみ |
| `/maybe` | 🤔 | 未定・検討中 | 曜日＋日付 |
| `/trip` | ✈️ | 出張・旅行 | 曜日＋日付 |
| `/will` | 📅 | 予定あり | 曜日＋日付 |
| `/can` | 💡 | 対応可能 | 曜日＋日付 |

## 🔧 技術仕様

### データ構造

`state.json`に以下の形式で保存：

```json
{
  "schedules": {
    "ユーザー名": {
      "2026-01-15": {
        "status": "in",
        "note": "午前中外出"
      }
    }
  },
  "board_message": {
    "channel": "C123456789",
    "ts": "1234567890.123456"
  }
}
```

### パーサー仕様

- **トークンベース**: スペースで区切られた各トークンを個別に解析
- **カンマをスペースに変換**: `2/1,2/2`は`2/1 2/2`と同じ
- **厳格な日付形式**: 月/日の両方を指定（`2/1-5`は無効）
- **範囲指定**: ハイフンの前後にスペースがないこと
- **曜日範囲**: `mon-fri`で月〜金の連続した曜日
### バックグラウンドタスク

- **日付変更チェッカー**: 1時間ごとに日付をチェック
- **自動更新**: 0時を過ぎるとボードを自動更新
- **デーモンスレッド**: メインプログラム終了時に自動終了
- **調整可能**: `time.sleep(3600)` の値を変えるとチェック間隔を調整可能
### デバッグモード

```bash
DEBUG=1 python app.py
```

デバッグログが標準出力に表示されます。

## 🔒 管理者機能

環境変数`ADMIN_USERS`に登録されたユーザーのみ実行可能：

```bash
/delete  # チャンネル内のボットメッセージを全削除
```

## 📝 ファイル構成

```
.
├── app.py                   # メインアプリケーション
├── state.json              # データファイル（自動生成）
├── sync_board.py           # ボード即時同期スクリプト
├── test_parser.py          # パーサーのテスト
├── new_parser.py           # パーサーのスタンドアロン実装
├── SLACK_CANVAS_GUIDE.md   # ユーザー向けガイド
├── README.md               # このファイル
├── .env                    # 環境変数（要作成）
└── .gitignore             # Git除外設定
```

### sync_board.py - ボードの即時同期

`state.json`を直接編集した後、Slackのボードメッセージを更新します。

**⚠️ 重要：`sync_board.py`を実行した場合は必ずボットを再起動してください**

ボットはメモリ上にstateを保持しているため、ファイルを編集しただけではボットのメモリは更新されません。再起動せずに次のコマンドを実行すると、編集内容が上書きされます。

**使い方：**

```bash
# 1. state.jsonを編集
# 2. ボードの表示を更新
python sync_board.py
# 3. ボットを再起動（必須）
systemctl --user restart presence-bot
```

**用途：**
- `state.json`のschedulesを手動で修正した場合
- `/delete`コマンド実行後に`board_message`がnullになった場合
- ボードとデータファイルが不一致の際の強制同期

**注意：**
- state.json編集後は必ず`systemctl --user restart presence-bot`を実行してください
- 再起動なしでsync_board.pyだけ実行しても、次のコマンド実行時に編集内容が失われます

## 🐛 トラブルシューティング

### ボードが表示されない

1. **`/setup`で再作成**
   ```bash
   /setup
   ```

2. **state.jsonを編集した場合**
   ```bash
   # ボットを再起動（必須）
   systemctl --user restart presence-bot
   
   # ボード表示を更新（オプション）
   python3 sync_board.py
   ```
   またはSlackで `/update` を実行

### ボードが自動更新されない

- `state.json`の`board_message`が`null`になっていないか確認
- `null`の場合は`/setup`を実行して再作成
- `/delete`コマンド実行後は必ず`/setup`が必要

### コマンドが反応しない
- Socket Modeが有効になっているか確認
- ボットトークンとアプリトークンが正しいか確認
- ボットに必要な権限があるか確認

### 日付が認識されない
- 日付形式が正しいか確認（`月/日`形式必須）
- 範囲指定のハイフンの前後にスペースがないか確認

### 過去の日付が残っている
ボードは自動更新時に過去の日付をクリーンアップします。手動で更新したい場合は任意のコマンドを実行してください。

## 📄 ライセンス

このプロジェクトは個人・組織での自由な利用が可能です。

## 🤝 コントリビューション

バグ報告や機能要望は、Issueまたはプルリクエストでお願いします。

